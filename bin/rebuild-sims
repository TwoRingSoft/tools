#! /usr/bin/env ruby

require 'json'

# get the lists of device types and runtimes 
@device_types = JSON.parse(`xcrun simctl list -j devicetypes`)
@runtimes = JSON.parse(`xcrun simctl list -j runtimes`)

def put_and_exe command
  puts command
  `#{command}`
end

puts 'Deleting simulators...'
puts

put_and_exe 'xcrun simctl delete unavailable'

# delete all simulators
put_and_exe "xcrun simctl list -j devices | jq '[.devices[]] | flatten | .[] | .udid' | xargs -t -I @ xcrun simctl delete @"

# sometimes simctl list misses some things
user = `whoami`.strip
simulator_dir = "/Users/#{user}/Library/Developer/CoreSimulator/Devices"
leftover_simulators = Dir.entries(simulator_dir).select do |child| 
  child != '.' && child != '..' && File.directory?(simulator_dir + '/' + child)
end
if leftover_simulators.count > 0 then
  puts
  puts "The following were not removed by simctl, consider manually deleting:"
  puts
  puts leftover_simulators.map {|dir| simulator_dir + '/' + dir}
end

puts
puts 'Creating simulators...'
puts

# given a runtime keyword (e.g. 'iphone') and a set of device type keywords (e.g. 'ios'), find all runtimes matching the runtime keyword, and all device types that match one of the device type keywords, take the cartesian product of runtimes and device types and create a simulator for each entry in that product
def create_simulators runtime_keyword, device_type_keywords
  selected_runtimes = @runtimes['runtimes'].select do |runtime| 
    runtime['name'].downcase.include?(runtime_keyword)
  end
  selected_device_types = @device_types['devicetypes'].select do |device_type| 
    device_type_keywords.select do |keyword| 
      device_type['name'].downcase.include?(keyword)
    end.size > 0
  end
  selected_runtimes.product(selected_device_types).each do |runtime_device_type_pair_array|
    runtime = runtime_device_type_pair_array.first
    device_type = runtime_device_type_pair_array.last
    create_command = "xcrun simctl create '#{device_type['name']} (#{runtime['name']})' #{device_type['identifier']} #{runtime['identifier']}"
    puts create_command
    `#{create_command}`
  end
end

# create simulators for each runtime/device relationship
create_simulators 'ios', ['iphone', 'ipad']
create_simulators 'tv', ['tv']
create_simulators 'watch', ['watch']

puts
puts 'Summary:'
puts

# print summary
list_command = 'xcrun simctl list devices'
puts list_command
puts `#{list_command}`
